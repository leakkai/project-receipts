package com.rp.controller;

import java.text.ParseException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.rp.model.AddressReq;
import com.rp.model.RequestClass;

import ResponseHolder.ResponseHolder;

@Controller    // This means that this class is a Controller
@RequestMapping(path="/receipt/") // This means URL's start with /user (after Application path)
public class ReceiptHeaderController {

	@Autowired// This means to let Spring auto create the bean
    // Which is auto-generated by Spring, we will use it to handle the data
	ReceiptHeaderSvc rhSvc;
	
	@Autowired
	AddressSvc addSvc;
	
    @GetMapping("")
    public String simpleView(Model model) {
    	model.addAttribute("request", new RequestClass());
    	return "/receipt/home";
    }
    
/*	@PostMapping("process")
    public String processTransaction(@Valid RequestClass request, BindingResult bindingResult, Model model) throws ParseException {

		try {
	        if (bindingResult.hasErrors()) {
	            return "rh";
	        }        
	        
	        rhSvc.processTransaction(request);
	        
	        return this.simpleView(model);
		}
		catch (Exception e) {
			//add error later
			return this.simpleView(model); 
		}
    }*/
	
	@RequestMapping(value = "process", produces = "application/json", method = RequestMethod.POST)
    public String processTransaction(@RequestBody RequestClass request, BindingResult bindingResult, Model model) throws ParseException {

		try {
	        if (bindingResult.hasErrors()) {
	            return "rh";
	        }        
	        
	        rhSvc.processTransaction(request);
	        
	        return this.simpleView(model);
		}
		catch (Exception e) {
			//add error later
			return this.simpleView(model); 
		}
    }

	@RequestMapping(value = "getAddress/{storeName}", produces = "application/json", method = RequestMethod.GET)
	@ResponseBody
    public ResponseHolder getAddress(@PathVariable("storeName") String storeName) throws ParseException {
		ResponseHolder response = new ResponseHolder();
		
		try {
			response.setStatus("success");
			response.setObject(addSvc.getAddress(storeName));
		}
		catch (Exception e) {
			response.setStatus(e.getMessage());
		}
		
		return response;
    }	
	
	@RequestMapping(value = "addAddress", produces = "application/json", method = RequestMethod.POST)
    public @ResponseBody String addAddress(@RequestBody AddressReq request) {

		String response = null;
		try {
			response = addSvc.addAddress(request);
		}
		catch (Exception e) {
			response = "{\"status\":\"" + e.getMessage() + "\"}";
		}
		return response;
    }

}